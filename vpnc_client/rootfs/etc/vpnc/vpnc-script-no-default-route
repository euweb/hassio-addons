#!/bin/sh
# vpnc-script without default route modification
# Modified for BusyBox/Alpine Linux

set -e

# =========== tunnel interface handling ====================================

do_ifconfig() {
    # Determine MTU
    if [ -n "$INTERNAL_IP4_MTU" ]; then
        MTU=$INTERNAL_IP4_MTU
    else
        MTU=1412
    fi

    # Configure tunnel interface
    ip link set dev "$TUNDEV" up mtu ${MTU}
    ip addr add "$INTERNAL_IP4_ADDRESS" peer "$INTERNAL_IP4_ADDRESS" dev "$TUNDEV"
}

# =========== route handling ====================================

do_route() {
    # Add host route to VPN gateway if it's not in the local network
    if [ -n "$VPNGATEWAY" ]; then
        # Check if gateway is already reachable
        if ! ip route get "$VPNGATEWAY" >/dev/null 2>&1; then
            DEFAULTGW=$(ip route show default | awk '/default/ {print $3}')
            if [ -n "$DEFAULTGW" ]; then
                ip route add "$VPNGATEWAY/32" via "$DEFAULTGW" 2>/dev/null || true
            fi
        fi
    fi

    # If the server sends split-network settings, use those
    if [ -n "$CISCO_SPLIT_INC" ]; then
        i=0
        while [ $i -lt $CISCO_SPLIT_INC ] ; do
            eval NETWORK="\$CISCO_SPLIT_INC_${i}_ADDR"
            eval NETMASKLEN="\$CISCO_SPLIT_INC_${i}_MASKLEN"
            if [ -n "$NETWORK" ]; then
                ip route add "$NETWORK/$NETMASKLEN" dev "$TUNDEV"
            fi
            i=`expr $i + 1`
        done
    fi
}

# =========== main handlers ====================================

do_connect() {
    do_ifconfig
    do_route
}

do_disconnect() {
    # Remove split network routes
    if [ -n "$CISCO_SPLIT_INC" ]; then
        i=0
        while [ $i -lt $CISCO_SPLIT_INC ] ; do
            eval NETWORK="\$CISCO_SPLIT_INC_${i}_ADDR"
            eval NETMASKLEN="\$CISCO_SPLIT_INC_${i}_MASKLEN"
            if [ -n "$NETWORK" ]; then
                ip route del "$NETWORK/$NETMASKLEN" dev "$TUNDEV" 2> /dev/null || true
            fi
            i=`expr $i + 1`
        done
    fi
    
    # Remove VPN gateway route
    if [ -n "$VPNGATEWAY" ]; then
        ip route del "$VPNGATEWAY/32" 2> /dev/null || true
    fi
    
    # Bring interface down
    ip link set dev "$TUNDEV" down 2> /dev/null || true
}

# ========= main script code =================

case "$reason" in
    pre-init)
        # Called before connecting, nothing to do
        exit 0
        ;;
    connect)
        do_connect
        ;;
    disconnect)
        do_disconnect
        ;;
    *)
        # Ignore unknown reasons
        exit 0
        ;;
esac

exit 0
